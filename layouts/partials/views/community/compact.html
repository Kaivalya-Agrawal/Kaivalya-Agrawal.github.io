{{/* layouts/partials/views/community/compact.html */}}

{{/* ---------- single item renderer (used in both modes) ---------- */}}
{{- define "pub_item" -}}
  {{- $p := . -}}
  {{- $res := $p.Resources.GetMatch "featured*" -}}

  {{- $paramFeatured := "" -}}
  {{- with $p.Params.featured_image -}}
    {{- if not (reflect.IsMap .) -}}
      {{- $paramFeatured = . -}}
    {{- end -}}
  {{- end -}}

  <article class="flex items-start gap-6">
    {{ if $res }}
      {{ $thumb := $res.Fill "100x100 smart q80" }}
      <div class="shrink-0 block overflow-hidden rounded-lg shadow-sm" style="width:100px;height:100px">
        <img src="{{ $thumb.RelPermalink }}" alt="{{ $p.Title }}" width="{{ $thumb.Width }}" height="{{ $thumb.Height }}"
             loading="lazy" style="width:100%;height:100%;object-fit:cover">
      </div>
    {{ else if $paramFeatured }}
      <div class="shrink-0 block overflow-hidden rounded-lg shadow-sm" style="width:100px;height:100px">
        <img src="{{ $paramFeatured | relURL }}" alt="{{ $p.Title }}" loading="lazy"
             style="width:100%;height:100%;object-fit:cover">
      </div>
    {{ else }}
      <div class="shrink-0" style="width:100px;height:100px"></div>
    {{ end }}

    <div class="min-w-0">
      <h3 class="text-2xl font-semibold leading-snug">{{ $p.Title }}</h3>

      {{ with $p.Params.authors }}
        {{- $list := slice -}}
        {{- range . -}}
          {{- $slug := . -}}
          {{- $pg := site.GetPage (printf "authors/%s" $slug) -}}
          {{- if $pg -}}
            {{- $name := $pg.Params.name | default $pg.Title | default $slug -}}
            {{- $list = $list | append $name -}}
          {{- else -}}
            {{- $list = $list | append $slug -}}
          {{- end -}}
        {{- end -}}
        <p class="text-base opacity-85 mt-1">{{ delimit $list ", " }}</p>
      {{ end }}

      {{- $venue := $p.Params.venue | default $p.Params.publication | default "" -}}
      {{- $status := $p.Params.status | default "" -}}
      {{ if or $venue $status }}
        <p class="text-base opacity-80 mt-1" style="font-style: italic;">
          <em style="font-style: inherit;">
            {{ with $status }}<span>{{ . }}</span>{{ end }}
            {{ if and $status $venue }}<span> · </span>{{ end }}
            {{ with $venue }}<span>{{ . }}</span>{{ end }}
          </em>
        </p>
      {{ end }}

      {{- $links := $p.Params.links | default (slice) -}}
      {{- if gt (len $links) 0 }}
        <div class="mt-3 flex flex-wrap gap-3 text-sm">
          {{- range $links }}
            {{- $label := "" -}}
            {{- $url := "" -}}

            {{- if and (eq .type "preprint") (eq .provider "arxiv") (isset . "id") -}}
              {{- $label = "arXiv" -}}{{- $url = (printf "https://arxiv.org/abs/%s" .id) -}}
            {{- else if eq .type "preprint" -}}
              {{- $label = (.label | default "Preprint") -}}{{- $url = .url -}}
            {{- else if eq .type "pdf" -}}
              {{- $label = (.label | default "PDF") -}}{{- $url = .url -}}
            {{- else if eq .type "code" -}}
              {{- $label = (.label | default "Code") -}}{{- $url = .url -}}
            {{- else if eq .type "dataset" -}}
              {{- $label = (.label | default "Dataset") -}}{{- $url = .url -}}
            {{- else if eq .type "video" -}}
              {{- $label = (.label | default "Video") -}}{{- $url = .url -}}
            {{- else if eq .type "poster" -}}
              {{- $label = (.label | default "Poster") -}}{{- $url = .url -}}
            {{- else if eq .type "slides" -}}
              {{- $label = (.label | default "Slides") -}}{{- $url = .url -}}
            {{- else if and (isset . "label") (isset . "url") -}}
              {{- $label = .label -}}{{- $url = .url -}}
            {{- end -}}

            {{- if $url }}
              <a href="{{ $url }}" target="_blank" rel="noopener"
                 class="px-3 py-1.5 rounded border border-current/20 hover:underline">{{ $label }}</a>
            {{- end }}
          {{- end }}
        </div>
      {{- end }}
    </div>
  </article>
{{- end -}}

{{/* ---------- decide mode: per-item vs list ---------- */}}
{{- $one := .item -}}
{{- if $one }}
  {{/* The collection block is already looping — render a single item. */}}
  {{ template "pub_item" $one }}
{{- else -}}
  {{/* We need to loop here — build & sanitize the list. */}}
  {{- $items := .Items | default .items | default (slice) -}}
  {{- if not (gt (len $items) 0) -}}
    {{- $items = where site.RegularPages "Section" "publications" -}}
  {{- end -}}
  {{- $items = where $items "Section" "publications" -}}
  {{- $items = where $items "Kind" "page" -}}
  {{- $items = where $items "BundleType" "leaf" -}}

  {{- $seen := dict -}}
  {{- $unique := slice -}}
  {{- range $items }}
    {{- $key := .RelPermalink -}}
    {{- if not (index $seen $key) -}}
      {{- $seen = merge $seen (dict $key true) -}}
      {{- $unique = $unique | append . -}}
    {{- end -}}
  {{- end -}}

  {{ if gt (len $unique) 0 }}
    <div class="space-y-7">
      {{- range $unique }}
        {{ template "pub_item" . }}
      {{- end }}
    </div>
  {{ else }}
    <p class="opacity-70 text-base">No items found for “publications”.</p>
  {{ end }}
{{- end }}
